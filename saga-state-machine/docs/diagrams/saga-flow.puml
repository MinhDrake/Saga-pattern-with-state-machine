@startuml Saga Flow

title E-commerce Order Saga Flow

skinparam participant {
    BackgroundColor<<service>> LightBlue
    BackgroundColor<<engine>> LightGreen
}

actor Customer
participant "API Gateway" as API
participant "SagaEngine" as Engine <<engine>>
participant "StateHandler" as Handler <<engine>>
database "Database" as DB

box "External Services" #LightYellow
participant "Inventory\nService" as Inventory <<service>>
participant "Payment\nGateway" as Payment <<service>>
participant "Shipping\nService" as Shipping <<service>>
end box

== Order Placement ==

Customer -> API: Place Order
API -> Engine: start(orderCommand)

Engine -> DB: Create saga (INIT)
Engine -> Handler: process(INIT)

Handler -> Handler: Run Before Hooks\n(validation, dedup)
Handler -> DB: Update status (PROCESSING)

== Step 1: Reserve Inventory ==

Handler -> Inventory: POST /reserve
activate Inventory
Inventory --> Handler: Reserved ✓
deactivate Inventory
Handler -> DB: Save step (SUCCEEDED)

== Step 2: Charge Payment ==

Handler -> Payment: POST /charge
activate Payment
Payment --> Handler: Charged ✓
deactivate Payment
Handler -> DB: Save step (SUCCEEDED)

== Step 3: Create Shipment ==

Handler -> Shipping: POST /shipment
activate Shipping
Shipping --> Handler: Created ✓
deactivate Shipping
Handler -> DB: Save step (SUCCEEDED)

== Completion ==

Handler -> DB: Update status (SUCCESS)
Handler -> Handler: Run After Hooks\n(notification, logging)
Engine --> API: Order completed
API --> Customer: Order confirmation

@enduml
